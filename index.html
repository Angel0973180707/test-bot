<script>
    const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbzeuQFds9g_H5_Wa7CIYSQs5k2KHBdDG45zPNNJF74xPfYU9NkSYXLBSKDZzcCWjaF3OA/exec";

    async function fetchFromCloud() {
        const input = document.getElementById('userInput').value.trim();
        const loading = document.getElementById('loading');
        const panel = document.getElementById('response-panel');
        const voice = document.getElementById('angelVoice');
        const navBtn = document.getElementById('navBtn');

        if (!input) return alert("小天使笑長正在聽，請輸入您的煩惱...");

        loading.style.display = "block";
        panel.style.display = "none";

        try {
            const response = await fetch(CLOUD_API_URL);
            const data = await response.json();
            
            // 找出符合關鍵字的資料 (根據笑長的 A 欄標題)
            const match = data.find(row => {
                const keys = row["偵測關鍵字（家長的心聲）"] || row.偵測關鍵字 || row.Keywords || "";
                return keys.toString().split('、').some(k => input.includes(k.trim()));
            });

            loading.style.display = "none";
            panel.style.display = "block";

            if (match) {
                // 1. 顯示回應文字 (對應 B 欄：解決方案)
                voice.innerHTML = match["解決方案"] || match.Response || "笑長正在為您祈福...";
                
                // 2. 設定按鈕文字 (對應 D 欄：目標分頁)
                const pageName = match["目標分頁"] || match.Page || "幸福展廳";
                navBtn.innerText = `🎬 前往 ${pageName}`;
                
                // 3. 設定按鈕連結 (優先抓取 G 欄：工具素材)
                // 如果 G 欄沒填，就抓 H 欄：影片素材1
                const link = match["工具素材"] || match["影片素材1"] || match.PWALink || "";
                
                if (link && link.includes("http")) {
                    navBtn.style.display = "block";
                    navBtn.onclick = () => { window.location.href = link; };
                } else {
                    navBtn.innerText = "🎬 內容準備中";
                    navBtn.onclick = () => { alert("笑長正在努力製作這個內容，請先讀讀幸福經喔！"); };
                }
            } else {
                voice.innerText = "笑長溫柔地聽著... 這份智慧尚未存入雲端。請試試搜尋「生氣」或「不專心」，或先點開上方【教養幸福經】。";
                navBtn.style.display = "none";
            }
        } catch (error) {
            loading.innerText = "❌ 連線失敗：請確保 API 已發佈為「任何人」。";
            console.error(error);
        }
    }
</script>
